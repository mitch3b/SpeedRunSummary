<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script>

function getPlaceAsHumanReadable(number) {
  if(number == 1) return "WR";

  var lastDigit = number % 10;

  if(lastDigit == 1) {
    return number + "st";
  } 
  if(lastDigit == 2) {
    return number + "nd";
  }
  if(lastDigit == 3) {
    return number + "rd";
  }

  return number + "th";
}

//This is used to track async calls so that, once they're all done, we can sort and display
var pendingRequests = 0;
var allRuns = [];

function allRunsFetched() {
  //Sort all alphabetically
  allRuns.sort(function(a, b){
    return a.textContent.localeCompare(b.textContent);
  });

  var parent = document.getElementById("outputDiv");
  //Clear the 'fetching data' status then write the output
  parent.innerHTML = "";
  for (var i = 0; i < allRuns.length; i++){ 
    parent.appendChild(allRuns[i]);

     //In wiki markup, you need this extra whitespace to force a new line            
     var wikiNewLine = document.createTextNode("\u00A0\u00A0");
     parent.appendChild(wikiNewLine);
   
     //Still need the line break to force the full new lines
     var linebreak = document.createElement('br');
     parent.appendChild(linebreak);
   }
}

function toWikiMarkup(speedrun, elementToWriteTo) {
  var AJAX = [];
  pendingRequests++;

  AJAX.push($.getJSON("https://www.speedrun.com/api/v1/games/" + speedrun.run.game + "?callback=?"));
  AJAX.push($.getJSON("https://www.speedrun.com/api/v1/categories/" + speedrun.run.category + "?callback=?"));

  $.when.apply($, AJAX).done(function(){
    //Pull these based on the order we called them in. 
    //The second index refers to the following structure: [data, statusText, jqXHR]
    var gameInfo = arguments[0][0];
    var categoryInfo = arguments[1][0];

    var gameName = gameInfo.data.names.twitch;
    var category = categoryInfo.data.name;
    var place = getPlaceAsHumanReadable(speedrun.place);
    var time = "12:34";
    var link = speedrun.run.weblink;

    elementToWriteTo.nodeValue = gameName + " - " + category + ": [" + time + "](" + link + ") (" + place + ")";

    pendingRequests--;

    if(pendingRequests == 0) {
      allRunsFetched();
    }
  });
}

$(document).ready(function(){
    $("button").click(function(){

      var parent = document.getElementById("outputDiv");
      //Clear the previous results
      parent.innerHTML = "Fetching data";

      var username = document.getElementById('usernameTextBox').value;
      var url = "https://www.speedrun.com/api/v1/users/" + username + "/personal-bests?callback=?";
      
      pendingRequests++;

      $.getJSON(url, function(result){
          parent.innerHTML = "Fetching " + result.data.length + " entries.";

          //This is just the top level which is just "data"
          $.each(result, function(key, datalist){
            //This is to iterate the data list
            $.each(datalist, function(i, listItem){
              var element = document.createTextNode("");
	      allRuns[i] = element;         

              toWikiMarkup(listItem, element);
            });
          });
       pendingRequests--;
       
       if(pendingRequests == 0) {
         allRunsFetched();
       }
     }).fail(function (jqXHR, textStatus, errorThrown) {
        parent.innerHTML = "Could not retrieve info for user: " + username; 
      })
   });
});
</script>
</head>
<body>
This is an example of fetching best times from speedrun.com for display on a wiki (ie twitch panels). Eventually will add other features (configurable output style?). The eventual goal would be to have uploads to speedrun.com update your twitch page automagically but I'm not sure that's possible given current twitch api. 

</br></br>
It will output in the form: </br>
Super Pitfall - Any%: 12:34 (2nd)
</br></br>
where the time will link to the video. 
</br> 

</br>
username: <input name="usernameTextBox" id="usernameTextBox" type="text" />
</br>
<button>Generate wiki markup </button>

<div id="outputDiv"></div>

</body>
</html>

